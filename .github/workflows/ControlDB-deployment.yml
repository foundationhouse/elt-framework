name: ControlDB Deployment - Microsoft Fabric

on:
  push:
    branches:
      - main
  workflow_dispatch:  # keep manual trigger if you want

jobs:
    release:      
      runs-on: windows-latest
      steps:
        - name: Checkout code 
          uses: actions/checkout@v3

        - name: Setup MSBuild
          uses: microsoft/setup-msbuild@v1.1

        - name: Setup .NET SDK
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: '8.0.x'

        - name: Azure Login
          uses: Azure/login@v1
          with:
           creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'

        # Build either a .sln (preferred) or a .sqlproj if there is no solution
        - name: Build Database Project (auto-detect)
          shell: pwsh
          run: |
            $ErrorActionPreference = "Stop"
        
            # Show tree for troubleshooting
            Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse | Select-Object FullName
        
            # Try to find a solution first
            $sln = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter *.sln -Recurse | Select-Object -First 1
        
            # Otherwise fall back to a .sqlproj
            $sqlproj = $null
            if (-not $sln) {
              $sqlproj = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter *.sqlproj -Recurse | Select-Object -First 1
              if (-not $sqlproj) { Write-Error "No .sln or .sqlproj found under $env:GITHUB_WORKSPACE"; exit 1 }
            }

        - name: Find Dacpac File
          id: find-dacpac
          shell: pwsh
          run: |
            $ErrorActionPreference = "Stop"
            # Search for any .dacpac produced in the repo
            $dacpac = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter *.dacpac -Recurse | Select-Object -First 1
            if ($dacpac) {
              Write-Host "Found dacpac: $($dacpac.FullName)"
              "dacpac-path=$($dacpac.FullName)" | Out-File -FilePath $env:GITHUB      "dacpac-path=$($dacpac.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            } else {
              Write-Error "Dacpac file not found. Build may have failed or output path differs."

        - name: Install SqlPackage
          id: install-sqlpackage
          run: |
            # Check for SqlPackage in common locations
            $sqlPackagePaths = @(
              "$env:ProgramFiles\Microsoft SQL Server\160\DAC\bin\SqlPackage.exe",
              "$env:ProgramFiles\Microsoft SQL Server\150\DAC\bin\SqlPackage.exe",
              "$env:ProgramFiles (x86)\Microsoft SQL Server\160\DAC\bin\SqlPackage.exe",
              "$env:ProgramFiles (x86)\Microsoft SQL Server\150\DAC\bin\SqlPackage.exe"
            )
            
            $sqlPackagePath = $null
            foreach ($path in $sqlPackagePaths) {
              if (Test-Path $path) {
                $sqlPackagePath = $path
                Write-Host "Found SqlPackage at: $sqlPackagePath"
                break
              }
            }

            if (-not $sqlPackagePath) {
              Write-Host "SqlPackage not found, downloading..."
              $sqlPackageUrl = "https://aka.ms/sqlpackage/win-x64"
              $sqlPackagePath = "$env:ProgramFiles\Microsoft SQL Server\160\DAC\bin\SqlPackage.exe"
              $sqlPackageDir = Split-Path $sqlPackagePath -Parent

              New-Item -ItemType Directory -Force -Path $sqlPackageDir | Out-Null
              Invoke-WebRequest -Uri $sqlPackageUrl -OutFile "$env:TEMP\sqlpackage.zip"
              Expand-Archive -Path "$env:TEMP\sqlpackage.zip" -DestinationPath $sqlPackageDir -Force
              Write-Host "SqlPackage installed at: $sqlPackagePath"            }

            echo "sqlpackage-path=$sqlPackagePath" >> $env:GITHUB_OUTPUT

        - name: Deploy to Fabric SQL
          run: |
            $sqlPackagePath = "${{ steps.install-sqlpackage.outputs.sqlpackage-path }}"
            $dacpacPath = "${{ steps.find-dacpac.outputs.dacpac-path }}"
            $connectionString = "${{ secrets.CONTROLDB_CONNECTIONSTRING }}"

            Write-Host "Deploying dacpac: $dacpacPath"
            Write-Host "Connection string format: Server=...;Database=...;Authentication=..." 

            & $sqlPackagePath /Action:Publish `
              /SourceFile:"$dacpacPath" `
              /TargetConnectionString:"$connectionString" `
              /p:DropPermissionsNotInSource=false `
              /p:BlockOnPossibleDataLoss=false `
              /p:DropRoleMembersNotInSource=false `
              /p:DropObjectsNotInSource=false `
              /p:IgnoreColumnOrder=true `
              /p:IgnorePermissions=true `
              /p:AllowIncompatiblePlatform=true `
              /p:ExcludeObjectTypes=Logins;Users

        - name: Azure Logout
          run: |
            az logout

 
