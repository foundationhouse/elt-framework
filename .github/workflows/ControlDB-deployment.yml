name: ControlDB Deployment - Microsoft Fabric

on:
  push:
    branches:
      - main
  workflow_dispatch:  # keep manual trigger if you want

jobs:
    release:      
      runs-on: windows-latest
      steps:
        - name: Checkout code 
          uses: actions/checkout@v3

        - name: Setup MSBuild
          uses: microsoft/setup-msbuild@v1.1

        - name: Setup .NET SDK
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: '8.0.x'

        - name: Azure Login
          uses: Azure/login@v1
          with:
           creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'

        # Build either a .sln (preferred) or a .sqlproj if there is no solution
        - name: Build Database Project (auto-detect)
          shell: pwsh
          run: |
            $ErrorActionPreference = "Stop"
        
            # Show tree for troubleshooting
            Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse | Select-Object FullName
        
            # Try to find a solution first
            $sln = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter *.sln -Recurse | Select-Object -First 1
        
            # Otherwise fall back to a .sqlproj
            $sqlproj = $null
            if (-not $sln) {
              $sqlproj = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter *.sqlproj -Recurse | Select-Object -First 1
              if (-not $sqlproj) { Write-Error "No .sln or .sqlproj found under $env:GITHUB_WORKSPACE"; exit 1 }
            }
            # Use MSBuild from VS2022 on the runner
            $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe"
            if (-not (Test-Path $msbuild)) {
              $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe"
            }
            if (-not (Test-Path $msbuild)) {
              $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe"
            }
            if (-not (Test-Path $msbuild)) { Write-Error "MSBuild not found"; exit 1 }
  
            if ($sln) {
              Write-Host "Building solution: $($sln.FullName)"
              & $msbuild $sln.FullName /p:Configuration=Release /p:Platform="Any CPU" /t:Build /v:m
            } else {
              Write-Host "Building sqlproj: $($sqlproj.FullName)"
              & $msbuild $sqlproj.FullName /p:Configuration=Release /t:Build /v:m
            }
        - name: Find DACPAC
          id: find-dacpac
          shell: pwsh
          run: |
            $ErrorActionPreference = "Stop"
            $dacpac = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter *.dacpac -Recurse | Select-Object -First 1
            if ($dacpac) {
              Write-Host "Found dacpac: $($dacpac.FullName)"
              "dacpac-path=$($dacpac.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            } else {
              Write-Error "DACPAC not found. Build may have failed or output path differs."
              exit 1
            }
            
        - name: Install SqlPackage (dotnet global tool)
          shell: pwsh
          run: |
            $ErrorActionPreference = "Stop"
            dotnet tool install --global Microsoft.SqlPackage
            # Verify on PATH for this session
            $env:PATH = "$env:USERPROFILE\.dotnet\tools;$env:PATH"
            sqlpackage /? | Out-Null
            Write-Host "SqlPackage installed."

        - name: Publish DACPAC to Fabric
          shell: pwsh
          run: |
            $ErrorActionPreference = "Stop"
            $dacpacPath = "${{ steps.find-dacpac.outputs.dacpac-path }}"
            $connectionString = "${{ secrets.CONTROLDB_CONNECTIONSTRING }}"
  
            Write-Host "Publishing DACPAC: $dacpacPath"
            Write-Host "Target: Fabric SQL connection string from secret (ADO.NET)"
  
            sqlpackage `
              /Action:Publish `
              /SourceFile:"$dacpacPath" `
              /TargetConnectionString:"$connectionString" `
              /p:DropPermissionsNotInSource=false `
              /p:BlockOnPossibleDataLoss=false `
              /p:DropRoleMembersNotInSource=false `
              /p:DropObjectsNotInSource=false `
              /p:IgnoreColumnOrder=true `
              /p:IgnorePermissions=true `
              /p:AllowIncompatiblePlatform=true `
              /p:ExcludeObjectTypes=Logins;Users

        - name: Azure Logout
          run: |
            az logout

 
