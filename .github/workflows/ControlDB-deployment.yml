
name: ControlDB Deployment

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Get runner public IP
        id: runner_ip
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ip = Invoke-RestMethod -Uri 'https://api.ipify.org'
          "ip=$ip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Azure Login (service principal)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          az login --service-principal `
            -u "${{ secrets.CLIENT_ID }}" `
            -p "${{ secrets.CLIENT_SECRET }}" `
            --tenant "${{ secrets.TENANT_ID }}"
          az account set --subscription "${{ secrets.SUBSCRIPTION_ID }}"

      - name: Allow runner IP on Azure SQL Server
        id: add_sql_fw
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ip = "${{ steps.runner_ip.outputs.ip }}"
          $ruleName = "gha-${{ github.run_id }}-${{ github.job }}"
          az sql server firewall-rule create `
            --resource-group "${{ secrets.SQL_RG }}" `
            --server "${{ secrets.SQL_SERVER }}" `
            --name $ruleName `
            --start-ip-address $ip `
            --end-ip-address $ip

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display checkout files and folders
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Get-ChildItem ${{ github.workspace }} -Recurse

      - name: Build and Deploy SQL Database
        uses: Azure/sql-action@v2
        with:
          connection-string: ${{ secrets.CONTROLDB_CONNECTIONSTRING }}
          path: ${{ github.workspace }}\elt-framework\ControlDB\ELT\Database.sqlproj
          action: Publish
          arguments: >
            /p:DropPermissionsNotInSource=false
            /p:BlockOnPossibleDataLoss=false
            /p:DropRoleMembersNotInSource=false
            /p:DropObjectsNotInSource=false
            /p:IgnoreColumnOrder=true
            /p:IgnorePermissions=true
            /p:AllowIncompatiblePlatform=true
            /p:ExcludeObjectTypes=Logins;Users

      - name: Remove runner IP from SQL Server firewall
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ruleName = "gha-${{ github.run_id }}-${{ github.job }}"
          az sql server firewall-rule delete `
            --resource-group "${{ secrets.SQL_RG }}" `
            --server "${{ secrets.SQL_SERVER }}" `
            --name $ruleName

      - name: Azure Logout
        shell: pwsh
        run: |
          az logout
``
